#
# Copyright (C) 2007-2016 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk
-include machinfo/$(LICHEE_IC)/common/build.mk
TINA_TARGET_ARCH:=$(ARCH)

PKG_NAME:=libgpu
PKG_VERSION:=1.0.0
PKG_RELEASE:=1

PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)

#PKG_BUILD_PARALLEL:=1
#PKG_INSTALL:=1

include $(INCLUDE_DIR)/package.mk

define Package/$(PKG_NAME)
  SECTION:=libs
  CATEGORY:=Allwinner
  SUBMENU:=Display
  TITLE:=GPU Library $(GPU_TYPE)
ifeq ($(GPU_TYPE),)
  DEPENDS:=
else ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), mali400))
  DEPENDS:=+kmod-mali-utgard-km +WESTON_DRM:wayland +WESTON_DRM:libdrm +WESTON_DRM:libffi
else ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), mali-t760))
  DEPENDS:=+kmod-mali-midgard-km
else ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), sgx544))
  DEPENDS:=+kmod-sgx544-km +libstdcpp
else ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), ge8300))
  DEPENDS:=+kmod-ge8300-km +libstdcpp +zlib
endif
endef

define Package/$(PKG_NAME)/description
endef

define Build/Prepare
endef

ifeq ($(CONFIG_WESTON_DRM),y)
    WINDOW_SYSTEM_TYPE:=wayland
else
    WINDOW_SYSTEM_TYPE:=fbdev
endif

GPU_3RDPARTY_INCLUDE_DIR:=$(GPU_TYPE)/3rdparty/include/khronos
GPU_INCLUDE_DIR:=$(GPU_TYPE)/$(WINDOW_SYSTEM_TYPE)/include
ifeq ($(CONFIG_COMPLILE_KERNEL64_USER64),y)
GPU_LIB_DIR:=$(GPU_TYPE)/$(WINDOW_SYSTEM_TYPE)/$(CONFIG_LIBC)/lib64
else ifeq ($(TINA_TARGET_ARCH),aarch64)
GPU_LIB_DIR:=$(GPU_TYPE)/$(WINDOW_SYSTEM_TYPE)/$(CONFIG_LIBC)/lib64
else ifeq ($(TINA_TARGET_ARCH),arm)
GPU_LIB_DIR:=$(GPU_TYPE)/$(WINDOW_SYSTEM_TYPE)/$(CONFIG_LIBC)/lib
else ifeq ($(TINA_TARGET_ARCH),riscv)
$(error Invalid TINA_TARGET_ARCH $(TINA_TARGET_ARCH))
else
$(warning Invalid TINA_TARGET_ARCH $(TINA_TARGET_ARCH))
endif

$(warning $(GPU_INCLUDE_DIR))

# This library only supports CONFIG_NO_STRIP or CONFIG_USE_STRIP,
# but not CONFIG_USE_SSTRIP. Therefore overwrite the original strip
# settings in $(TOPDIR)/rules.mk.
ifneq ($(CONFIG_NO_STRIP),)
  RSTRIP:=:
  STRIP:=:
else
  STRIP:=$(TARGET_CROSS)strip $(call qstrip,$(CONFIG_STRIP_ARGS))
  RSTRIP= \
    export CROSS="$(TARGET_CROSS)" \
                $(if $(PKG_BUILD_ID),KEEP_BUILD_ID=1) \
                $(if $(CONFIG_KERNEL_KALLSYMS),NO_RENAME=1) \
                $(if $(CONFIG_KERNEL_PROFILING),KEEP_SYMBOLS=1); \
    NM="$(TARGET_CROSS)nm" \
    STRIP="$(STRIP)" \
    STRIP_KMOD="$(SCRIPT_DIR)/strip-kmod.sh" \
    PATCHELF="$(STAGING_DIR_HOST)/bin/patchelf" \
    $(SCRIPT_DIR)/rstrip.sh
endif


define Build/Compile

endef

define Build/InstallDev
	mkdir -p $(PKG_INSTALL_DIR)
	$(INSTALL_DIR) $(PKG_INSTALL_DIR)/usr/lib
	$(CP) -uvd $(GPU_LIB_DIR)/* $(PKG_INSTALL_DIR)/usr/lib

	$(INSTALL_DIR) $(1)/usr/lib 
	$(INSTALL_DIR) $(1)/usr/include
	$(CP) -v $(GPU_3RDPARTY_INCLUDE_DIR)/* $(1)/usr/include
	$(CP) -uvd $(GPU_LIB_DIR)/* $(1)/usr/lib
ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), mali400))
	$(INSTALL_DIR) $(1)/usr/include
	$(CP) -v $(GPU_INCLUDE_DIR)/* $(1)/usr/include
else ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), mali-t760))
	$(INSTALL_DIR) $(1)/usr/include
	$(CP) -v $(GPU_INCLUDE_DIR)/* $(1)/usr/include
else ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), sgx544))
	$(INSTALL_DIR) $(1)/usr/bin
	$(CP) -uv $(GPU_LIB_DIR)/../bin/* $(1)/usr/bin
else ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), ge8300))
	$(INSTALL_DIR) $(1)/usr/bin
	$(CP) -uv $(GPU_LIB_DIR)/../bin/* $(1)/usr/bin
	$(INSTALL_DIR) $(1)/lib/firmware
	$(CP) $(GPU_LIB_DIR)/firmware/* $(1)/lib/firmware
endif

	$(INSTALL_DIR) $(1)/usr/lib/pkgconfig
ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), mali400 mali-t760))
	$(CP) -v pkgconfig/mali/*.pc $(1)/usr/lib/pkgconfig
else
	$(CP) -v pkgconfig/*.pc $(1)/usr/lib/pkgconfig
endif
ifeq ($(WINDOW_SYSTEM_TYPE),wayland)
	$(CP) -v $(GPU_TYPE)/wayland/pkgconfig/*.pc $(1)/usr/lib/pkgconfig
endif
endef

define Package/$(PKG_NAME)/install
	$(INSTALL_DIR) $(1)/usr/lib
	$(CP) -uvd $(GPU_LIB_DIR)/* $(1)/usr/lib
ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), mali400))
else ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), mali-t760))
else ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), sgx544))
	$(INSTALL_DIR) $(1)/usr/bin
	$(CP) -uv $(GPU_LIB_DIR)/../bin/* $(1)/usr/bin
else ifeq ($(GPU_TYPE), $(filter $(GPU_TYPE), ge8300))
	$(INSTALL_DIR) $(1)/usr/bin
	$(CP) -uv $(GPU_LIB_DIR)/../bin/* $(1)/usr/bin
	$(INSTALL_DIR) $(1)/lib/firmware
	$(CP) $(GPU_LIB_DIR)/firmware/* $(1)/lib/firmware
endif
endef

$(eval $(call BuildPackage,$(PKG_NAME)))
